# Basic setup for progress bar styling on the current journal
# This effect has to be run inside a scope where 'scope:journal_entry' is available!
# Parameters:
# - progress_bar = name localization key of progress bar
# - index = 0-indexed position of the given progress bar in the journal
# THIS DOES NOT REPLACE THE VANILLA SETUP
initialize_com_progress_bar = {
    hidden_effect = {
        if = {
            limit = {
                NOT = {
                    exists = scope:journal_entry
                }
            }
            error_log = "CMF: No journal_entry scope defined! This effect should be run in the immediate block of a journal entry!"
        }
        else = {
            if = {
                limit = {
                    NOT = { exists_com_progress_bar = { progress_bar = $progress_bar$ } }
                }
                create_struct = {
                    struct_type = com_struct_progress_bar
                    struct_scope = com_$progress_bar$
                }
                #root scope?
                add_to_variable_list = {
                    name = com_progress_bar_cache
                    target = scope:com_$progress_bar$
                }
            }
            else = {
                save_com_progress_bar_scope = { progress_bar = $progress_bar$ }
            }
            fix_variable_error = { variable = com_progress_bar_$index$ }
            fix_variable_error = { variable = com_$progress_bar$ }
            fix_variable_error = { variable = $progress_bar$ }
            # Set progress bar
            scope:journal_entry = {
                set_variable = {
                    name = com_progress_bar_$index$
                    value = scope:com_$progress_bar$
                }
            }
            # save id
            scope:com_$progress_bar$ = {
                set_variable = {
                    name = com_id
                    value = flag:$progress_bar$
                }
            }
        }
    }
}


# Basic setup for progress bar styling on the current journal
# This effect has to be run inside a scope where 'scope:journal_entry' is available!
# Parameters:
# - progress_bar = name localization key of progress bar
# - index = 0-indexed position of the given progress bar in the journal
# - color = color of base bar
# THIS DOES NOT REPLACE THE VANILLA SETUP
create_com_progress_bar = {
    initialize_com_progress_bar = {
        progress_bar = $progress_bar$
        index = $index$
    }
    set_com_progress_bar_color = {
        progress_bar = $progress_bar$
        color = $color$
    }
}

# General setup for progress bar styling on the current journal
# This effect has to be run inside a scope where 'scope:journal_entry' is available!
# Parameters:
# - progress_bar = name localization key of progress bar
# - index = 0-indexed position of the given progress bar in the journal
# - color = color of base bar
# - bar_increase_color = color of drift bar when increasing
# - bar_decrease_color = color of drift bar when decreasing
# - drift_value = a 0-1 script value which sets the size and direction of the drift 
# THIS DOES NOT REPLACE THE VANILLA SETUP
create_com_progress_bar_with_drift = {
    create_com_progress_bar = {
        progress_bar = $progress_bar$
        index = $index$
        color = $color$
    }
    set_com_progress_bar_drift = {
        progress_bar = $progress_bar$
        bar_increase_color = $bar_increase_color$
        bar_decrease_color = $bar_decrease_color$
        drift_value = $drift_value$
    }
}

# General setup for progress bar styling on the current journal
# This effect has to be run inside a scope where 'scope:journal_entry' is available!
# Parameters:
# - progress_bar = name localization key of progress bar
# - index = 0-indexed position of the given progress bar in the journal
# - color = color of base bar
# - target_type = icon type for target value
# - target_value = a 0-1 script value which sets the position of the target
# THIS DOES NOT REPLACE THE VANILLA SETUP
create_com_progress_bar_with_target = {
    create_com_progress_bar = {
        progress_bar = $progress_bar$
        index = $index$
        color = $color$
    }
    set_com_progress_bar_target = {
        progress_bar = $progress_bar$
        target_type = $target_type$
        target_value = $target_value$
    }
}

# Full setup for progress bar styling on the current journal
# This effect has to be run inside a scope where 'scope:journal_entry' is available!
# Parameters:
# - progress_bar = name localization key of progress bar
# - index = 0-indexed position of the given progress bar in the journal
# - color = color of base bar
# - bar_increase_color = color of drift bar when increasing
# - bar_decrease_color = color of drift bar when decreasing
# - drift_value = a 0-1 script value which sets the size and direction of the drift 
# - target_type = icon type for target value
# - target_value = a 0-1 script value which sets the position of the target
# THIS DOES NOT REPLACE THE VANILLA SETUP
create_com_progress_bar_with_both = {
    create_com_progress_bar = {
        progress_bar = $progress_bar$
        index = $index$
        color = $color$
    }
    set_com_progress_bar_drift = {
        progress_bar = $progress_bar$
        bar_increase_color = $bar_increase_color$
        bar_decrease_color = $bar_decrease_color$
        drift_value = $drift_value$
    }
    set_com_progress_bar_target = {
        progress_bar = $progress_bar$
        target_type = $target_type$
        target_value = $target_value$
    }
}

# This effect should be run when the journal entry concludes
# Parameters:
# - progress_bar = name localization key of progress bar
remove_com_progress_bar = {
    hidden_effect = {
        if = {
            limit = {
                NOT = {
                    exists_com_progress_bar = { progress_bar = $progress_bar$ }
                }
            }
            error_log = "CMF: Progress bar could not be found"
        }
        else = {
            # Retrieve progress bar
            random_in_list = {
                variable = com_progress_bar_cache
                limit = {
                    var:com_id ?= flag:$progress_bar$
                    var:com_type ?= com_struct_progress_bar
                }
                save_scope_as = com_internal_scope
            }

            # Remove progress bar from cache
            remove_list_variable = {
                name = com_progress_bar_cache
                target = scope:com_internal_scope
            }

            # Destroy progress bar
            destroy_struct = {
                struct = scope:com_internal_scope
            }
        }
    }
}

# Sets the color of progress bar
# Requires access to 'scope:com_$progress_bar$'
# - progress_bar = name localization key of progress bar
# - color = color of base bar
set_com_progress_bar_color = {
    hidden_effect = {
        if = {
            limit = {
                NOT = {
                    exists = scope:com_$progress_bar$
                }
            }
            error_log = error_no_progress_bar_scope
        }
        else = {
            fix_variable_error = { variable = com_base_color }
            fix_variable_error = { variable = com_$color$_bar }
            scope:com_$progress_bar$ = {
                set_variable = {
                    name = com_base_color
                    value = flag:com_$color$_bar
                }
            }
        }
    }
}

# Unsets the color of progress bar
# Requires access to 'scope:com_$progress_bar$'
# - progress_bar = name localization key of progress bar
remove_com_progress_bar_color = {
    hidden_effect = {
        if = {
            limit = {
                NOT = {
                    exists = scope:com_$progress_bar$
                }
            }
            error_log = error_no_progress_bar_scope
        }
        else = {
            scope:com_$progress_bar$ = {
                remove_variable = com_base_color
            }
        }
    }
}
# Sets the drift colors and the value to be used
# Requires access to 'scope:com_$progress_bar$'
# - progress_bar = name localization key of progress bar
# - bar_increase_color = color of drift bar when increasing
# - bar_decrease_color = color of drift bar when decreasing
# - drift_value = a 0-1 script value which sets the size and direction of the drift 
set_com_progress_bar_drift = {
    hidden_effect = {
        if = {
            limit = {
                NOT = {
                    exists = scope:com_$progress_bar$
                }
            }
            error_log = error_no_progress_bar_scope
        }
        else = {
            fix_variable_error = { variable = com_bar_increase_color }
            fix_variable_error = { variable = com_bar_decrease_color }
            fix_variable_error = { variable = com_drift_value }
            fix_variable_error = { variable = com_$bar_increase_color$_bar }
            fix_variable_error = { variable = com_$bar_decrease_color$_bar }
            fix_variable_error = { variable = $drift_value$ }
            scope:com_$progress_bar$ = {
                set_variable = {
                    name = com_bar_increase_color
                    value = flag:com_$bar_increase_color$_bar
                }
                set_variable = {
                    name = com_bar_decrease_color
                    value = flag:com_$bar_decrease_color$_bar
                }
                set_variable = {
                    name = com_drift_value
                    value = flag:$drift_value$
                }
            }
        }
    }
}

# Removes the progress bar drift effect
# Requires access to 'scope:com_$progress_bar$'
# - progress_bar = name localization key of progress bar
remove_com_progress_bar_drift = {
    hidden_effect = {
        if = {
            limit = {
                NOT = {
                    exists = scope:com_$progress_bar$
                }
            }
            error_log = error_no_progress_bar_scope
        }
        else = {
            scope:com_$progress_bar$ = {
                remove_variable = com_bar_increase_color
                remove_variable = com_bar_decrease_color
                remove_variable = com_drift_value
            }
        }
    }
}

# Sets the target icon/style and the value to be used
# Requires access to 'scope:com_$progress_bar$'
# - progress_bar = name localization key of progress bar
# - target_type = icon type for target value
# - target_value = a 0-1 script value which sets the position of the target
set_com_progress_bar_target = {
    hidden_effect = {
        if = {
            limit = {
                NOT = {
                    exists = scope:com_$progress_bar$
                }
            }
            error_log = error_no_progress_bar_scope
        }
        else = {
            fix_variable_error = { variable = com_target_type }
            fix_variable_error = { variable = com_target_value }
            fix_variable_error = { variable = com_target_$target_type$ }
            fix_variable_error = { variable = $target_value$ }
            scope:com_$progress_bar$ = {
                set_variable = {
                    name = com_target_type
                    value = flag:com_target_$target_type$
                }
                set_variable = {
                    name = com_target_value
                    value = flag:$target_value$
                }
            }
        }
    }
}

# Removes the progress bar target
# Requires access to 'scope:com_$progress_bar$'
# - progress_bar = name localization key of progress bar
remove_com_progress_bar_target = {
    hidden_effect = {
        if = {
            limit = {
                NOT = {
                    exists = scope:com_$progress_bar$
                }
            }
            error_log = error_no_progress_bar_scope
        }
        else = {
            scope:com_$progress_bar$ = {
                remove_variable = com_target_type
                remove_variable = com_target_value
            }
        }
    }
}

# Sets up an existing progress bar as an accessible scope
# This allows using effects and triggers that rely on the 'scope:com_$progress_bar$' outside the event chain
# - progress_bar = name localization key of progress bar
save_com_progress_bar_scope = {
    hidden_effect = {
        if = {
            limit = {
                exists_com_progress_bar = { progress_bar = $progress_bar$ }
            }
            random_in_list = {
                variable = com_progress_bar_cache
                limit = {
                    var:com_id ?= flag:$progress_bar$
                    var:com_type ?= com_struct_progress_bar
                }
                save_scope_as = com_$progress_bar$
            }
        }
        else = {
            error_log = error_no_progress_bar_scope
        }
    }
}

# Valid bar and drift colors:
## Blue - blue/default
## Red - red/bad
## Green - green
## Gold - gold
## White - white

# Valid target types:
## Journal icon - journal_icon
## Gold marker icon - gold_marker
## Gold divider bar - gold_bar
## Red divider line - red_line
## Blue divider line - blue_line
## Green divider line - green_line
## White divider line - white_line
## Gold divider line - gold_line

com_debug_progress_bar = {
    random_in_list = {
        variable = com_progress_bar_cache
        save_scope_as = com_test
    }
    set_variable = {
        name = com_id
        value = scope:com_test.var:com_id
    }
    set_variable = {
        name = com_base_color
        value = scope:com_test.var:com_base_color
    }
    set_variable = {
        name = com_bar_increase_color
        value = scope:com_test.var:com_bar_increase_color
    }
    set_variable = {
        name = com_bar_decrease_color
        value = scope:com_test.var:com_bar_decrease_color
    }
    set_variable = {
        name = com_drift_value
        value = scope:com_test.var:com_drift_value
    }
    set_variable = {
        name = com_target_type
        value = scope:com_test.var:com_target_type
    }
    set_variable = {
        name = com_target_value
        value = scope:com_test.var:com_target_value
    }
}